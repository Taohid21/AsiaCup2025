<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIVE Stream</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-darker: #0f172a; --bg-dark: #1e293b; --bg-medium: #334155;
      --text-light: #e2e8f0; --text-muted: #94a3b8; --accent: #38bdf8;
      --danger: #f43f5e; --live-red: #ef4444; --font-family: 'Poppins', sans-serif;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; overflow: hidden; margin: 0; background-color: var(--bg-darker); }
    body { 
      color: var(--text-light); font-family: var(--font-family); 
      display: flex; flex-direction: column;
    }
    
    .video-container { flex-shrink: 0; background-color: #000; width: 100%; line-height: 0; position: relative; }
    .app-container { display: flex; flex-direction: column; flex-grow: 1; max-width: 800px; width: 100%; margin: 0 auto; background-color: var(--bg-darker); overflow: hidden; }
    .video-wrapper { position: relative; background-color: #000; overflow: hidden; width: 100%; aspect-ratio: 16 / 9; max-height: 75vh; }
    .video-wrapper video { width: 100%; height: 100%; object-fit: contain; display: block; }
    .video-wrapper .ad-image-container { width: 100%; height: 100%; background-size: contain; background-repeat: no-repeat; background-position: center; display: none; }
    .video-loader { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; border: 5px solid rgba(255, 255, 255, 0.3); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; transform: translate(-50%, -50%); z-index: 10; display: none; }
    .video-wrapper.loading .video-loader { display: block; }
    @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
    .video-overlay-controls { position: absolute; bottom: 0; left: 0; right: 0; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; background: linear-gradient(to top, rgba(0,0,0,0.6), transparent); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; z-index: 20; }
    .video-wrapper:hover .video-overlay-controls, .video-wrapper.controls-visible .video-overlay-controls { opacity: 1; visibility: visible; }
    .live-indicator { display: flex; align-items: center; gap: 8px; background-color: rgba(0, 0, 0, 0.5); color: #fff; font-size: 14px; font-weight: 600; padding: 5px 12px; border-radius: 5px; user-select: none; }
    .live-indicator::before { content: ''; display: block; width: 9px; height: 9px; background-color: var(--live-red); border-radius: 50%; animation: pulse 1.5s infinite; }
    .ad-indicator { background-color: #ffc107; color: #000; font-weight: 600; font-size: 12px; padding: 3px 8px; border-radius: 4px; position: absolute; top: 10px; left: 10px; z-index: 21; display: none; }
    @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 50% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } }
    .control-btn { background: none; border: none; padding: 0; cursor: pointer; color: #fff; }
    .control-btn svg { width: 28px; height: 28px; fill: currentColor; filter: drop-shadow(0 0 4px rgba(0,0,0,0.6)); transition: transform 0.2s ease; }
    .control-btn:hover { color: var(--accent); }
    .control-btn:hover svg { transform: scale(1.1); }
    .floating-heart { position: absolute; bottom: 20px; font-size: 24px; opacity: 1; animation: floatUp 4s ease-out forwards; pointer-events: none; z-index: 25; }
    @keyframes floatUp { to { transform: translateY(-300px); opacity: 0; } }
    .server-selection { padding: 10px 16px; background-color: var(--bg-dark); display: flex; gap: 10px; align-items: center; flex-wrap: wrap; flex-shrink: 0; border-bottom: 1px solid var(--bg-medium); min-height: 48px; }
    .server-selection span { font-size: 14px; font-weight: 500; color: var(--text-muted); }
    .server-btn { background-color: var(--bg-medium); color: var(--text-light); border: 1px solid transparent; border-radius: 15px; padding: 5px 12px; font-size: 13px; font-family: var(--font-family); cursor: pointer; transition: all 0.2s ease; }
    .server-btn:hover { background-color: #475569; }
    .server-btn.active { background-color: var(--accent); color: var(--bg-darker); font-weight: 600; border-color: var(--accent); }
    .chat-wrapper { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
    .chat-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; background-color: var(--bg-dark); border-bottom: 1px solid var(--bg-medium); flex-shrink: 0; }
    .chat-header h1 { font-size: 16px; margin: 0; font-weight: 600; }
    .viewer-count { font-size: 14px; color: var(--text-muted); }
    .messages-box { flex-grow: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 16px; }
    .message { display: flex; gap: 12px; align-items: flex-start; max-width: 90%; animation: slideInUp 0.4s ease-out; }
    @keyframes slideInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    .message img.avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
    .message .content { background-color: var(--bg-dark); padding: 8px 12px; border-radius: 12px; border-top-left-radius: 0; max-width: 100%; }
    .message .metadata { display: flex; align-items: baseline; gap: 8px; margin-bottom: 4px; }
    .message .metadata .name { font-weight: 600; font-size: 13px; color: var(--accent); }
    .message .metadata .time { font-size: 11px; color: var(--text-muted); }
    .message .content .text { font-size: 15px; color: var(--text-light); line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
    .message .content .chat-image { max-width: 100%; border-radius: 8px; margin-top: 8px; display: block; cursor: pointer; }
    .typing-indicator { position: absolute; bottom: 75px; left: 16px; font-size: 13px; color: var(--text-muted); font-style: italic; background: var(--bg-dark); padding: 4px 10px; border-radius: 10px; z-index: 10; opacity: 0; transition: opacity 0.3s; }
    .typing-indicator.visible { opacity: 1; }
    .input-wrapper { flex-shrink: 0; background-color: var(--bg-dark); }
    #imagePreviewBox, #profileStatusBox { padding: 0 16px; }
    .image-preview, .profile-status { display: flex; align-items: center; gap: 10px; background-color: var(--bg-darker); border-radius: 8px; padding: 8px; margin-top: 8px; }
    .image-preview img, .profile-status img { height: 40px; width: 40px; object-fit: cover; border-radius: 4px; }
    .image-preview .filename, .profile-status .name { font-size: 13px; color: var(--text-muted); font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .image-preview button, .profile-status button { background: var(--danger); color: white; border: none; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; cursor: pointer; line-height: 22px; text-align: center; margin-left: auto; flex-shrink: 0; }
    .input-area { display: flex; gap: 8px; align-items: center; padding: 12px 16px; }
    .icon-btn { background: none; border: none; cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: center; border-radius: 50%; position: relative; flex-shrink: 0; }
    .icon-btn:hover { background-color: rgba(255,255,255,0.1); }
    .icon-btn svg { width: 24px; height: 24px; fill: var(--text-muted); transition: transform 0.2s; }
    #sendBtn svg { fill: var(--accent); }
    #sendBtn { transform: scale(0); transition: transform 0.2s ease; position: absolute; right: 0; }
    #sendBtn.visible { transform: scale(1); }
    #heartBtn.hidden { transform: scale(0); }
    .input-field { flex-grow: 1; min-width: 0; }
    .right-icons { position: relative; display: flex; align-items: center; }
    input[type="text"] { width: 100%; border: 1px solid var(--bg-medium); background-color: var(--bg-darker); border-radius: 20px; padding: 10px 16px; color: var(--text-light); font-size: 15px; font-family: var(--font-family); }
    input[type="text"]:focus { outline: none; border-color: var(--accent); }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal-content { background-color: var(--bg-dark); padding: 24px; border-radius: 16px; width: 90%; max-width: 380px; text-align: center; border: 1px solid var(--bg-medium); transform: scale(0.95); animation: scaleIn 0.3s ease forwards; }
    @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .modal-content h2 { margin-top: 0; font-size: 20px; font-weight: 600; }
    .modal-content p { color: var(--text-muted); font-size: 14px; margin-bottom: 20px; }
    #avatarPreview { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin: 0 auto 12px; display: none; }
    .avatar-upload-label { display: block; padding: 12px; border-radius: 8px; border: 2px dashed var(--bg-medium); cursor: pointer; margin-bottom: 12px; color: var(--text-muted); }
    .avatar-upload-label:hover { border-color: var(--accent); color: var(--accent); }
    .modal-content input { width: 100%; padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 1px solid var(--bg-medium); background: var(--bg-darker); color: #fff; font-family: var(--font-family); }
    .modal-content button { width: 100%; cursor: pointer; border: 0; padding: 12px; border-radius: 8px; background: var(--accent); color: var(--bg-darker); font-weight: 600; font-size: 16px; }
    .modal-content button:disabled { background-color: var(--bg-medium); cursor: not-allowed; }
    #gifModal .modal-content { max-width: 500px; padding: 0; overflow: hidden; }
    #gifSearchInput { width: calc(100% - 32px); margin: 16px; }
    #gifResults { height: 40vh; overflow-y: auto; padding: 0 16px 16px; display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; }
    #gifResults img { width: 100%; height: 100px; object-fit: cover; border-radius: 6px; cursor: pointer; transition: transform 0.2s; }
    #gifResults img:hover { transform: scale(1.05); }
    #lightbox { background-color: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
    #lightbox .modal-content { background: none; border: none; width: auto; height: auto; max-width: 90vw; max-height: 90vh; padding: 0; }
    #lightbox img { max-width: 100%; max-height: 100%; object-fit: contain; }
    #lightboxClose { position: absolute; top: 20px; right: 20px; color: #fff; font-size: 30px; cursor: pointer; background: none; border: none; padding: 0; }

    /* --- নতুন যোগ করা CSS --- */
    #playOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
      cursor: pointer;
      z-index: 15; /* ভিডিও লোডারের নিচে কিন্তু ভিডিওর উপরে */
      transition: opacity 0.3s ease;
    }
    #playOverlay.hidden {
      opacity: 0;
      pointer-events: none; /* হিডেন থাকা অবস্থায় যাতে ক্লিক না করা যায় */
    }
    #playOverlay .play-icon {
      width: 70px;
      height: 70px;
      fill: #fff;
      margin-bottom: 15px;
      filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
    }
    #playOverlay span {
      font-size: 16px;
      font-weight: 500;
      letter-spacing: 0.5px;
      user-select: none;
    }
  </style>
</head>
<body>

  <div class="video-container">
    <div class="video-wrapper" id="videoWrapper">
      <div class="video-loader"></div>
      <!-- 'muted' অ্যাট্রিবিউট যোগ করা হয়েছে -->
      <video id="videoPlayer" playsinline autoplay muted></video>

      <!-- নতুন "Click to Play" ওভারলে -->
      <div id="playOverlay">
        <svg class="play-icon" viewBox="0 0 24 24">
          <path d="M8,5.14V19.14L19,12.14L8,5.14Z" />
        </svg>
        <span>Click to Play</span>
      </div>

      <div class="ad-image-container" id="adImageContainer"></div>
      <div class="ad-indicator" id="adIndicator">Advertisement</div>
      <div class="video-overlay-controls">
        <div class="live-indicator" id="liveIndicator">LIVE</div>
        <button class="control-btn" id="fullscreenBtn" title="Fullscreen">
          <svg viewBox="0 0 24 24"><path d="M5,5H10V7H7V10H5V5M14,5H19V10H17V7H14V5M17,14H19V19H14V17H17V14M7,17H10V19H5V14H7V17Z"/></svg>
        </button>
      </div>
    </div>
    <div class="server-selection" id="serverSelection"></div>
  </div>

  <div class="app-container">
    <div class="chat-wrapper">
      <header class="chat-header"><h1>Live Chat</h1><div class="viewer-count" id="viewerCount">● 0 watching</div></header>
      <div class="messages-box" id="messagesBox"></div>
      <div class="typing-indicator" id="typingIndicator"></div>
      <div class="input-wrapper">
        <div id="profileStatusBox"></div>
        <div id="imagePreviewBox"></div>
        <div class="input-area">
          <button class="icon-btn" id="imageUploadBtn" title="Upload Image"><svg viewBox="0 0 24 24"><path d="M21.58,16.09L17.24,11.75C16.67,11.18 15.77,11.18 15.2,11.75L14.47,12.47L11.82,9.82C11.25,9.25 10.35,9.25 9.78,9.82L4.42,15.18C4.16,15.44 4,15.81 4,16.2V19C4,20.1 4.9,21 6,21H18C19.1,21 20,20.1 20,19V17.59C20,17.18 20.16,16.77 20.42,16.53L21.58,15.37C22.15,14.8 22.15,13.9 21.58,13.33M6,19L10.5,14.5L13.5,17.5L16.5,14.5L18,16V19H6M16,10C17.1,10 18,9.1 18,8C18,6.9 17.1,6 16,6C14.9,6 14,6.9 14,8C14,9.1 14.9,10 16,10M20,2H4C2.9,2 2,2.9 2,4V13.8C2,14.21 2.16,14.62 2.42,14.88L3.58,16.04C3,16.5 3,17.22 3,17.59V19C3,20.65 4.35,22 6,22H18C19.65,22 21,20.65 21,19V17.59C21.54,17.22 21.73,16.63 21.58,16.09L22.75,14.93C23.32,14.36 23.32,13.46 22.75,12.89L19,9L14.75,13.25L11.25,9.75L7,14L4,11V4H20V2Z"/></svg></button>
          <button class="icon-btn" id="gifBtn" title="Send GIF"><svg viewBox="0 0 24 24"><path d="M9,9V15H11V11H13V9M15,9A2,2 0 0,1 17,11V15H15V11H13V12A1,1 0 0,0 14,13A1,1 0 0,0 15,12A2,2 0 0,1 17,10A2,2 0 0,1 19,12V15H21V11A4,4 0 0,0 17,7A4,4 0 0,0 13,11V15H15V13H17V15H19V17H13A2,2 0 0,1 11,15V13H9V15A2,2 0 0,0 11,17H13V19H11A4,4 0 0,1 7,15V9H9M5,3H19A2,2 0 0,1 21,5V19A2,2 0 0,1 19,21H5A2,2 0 0,1 3,19V5A2,2 0 0,1 5,3Z" /></svg></button>
          <div class="input-field"><input type="text" id="msgInput" placeholder="Write a message..."></div>
          <input type="file" id="imageInput" accept="image/*" style="display:none;">
          <div class="right-icons">
            <button class="icon-btn" id="heartBtn" title="React"><svg viewBox="0 0 24 24"><path d="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z" /></svg></button>
            <button class="icon-btn" id="sendBtn" title="Send"><svg viewBox="0 0 24 24"><path d="M2,21L23,12L2,3V10L17,12L2,14V21Z" /></svg></button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="profileModal"><div class="modal-content"><img id="avatarPreview" src="#" alt="Avatar Preview"/><h2>Join the Chat</h2><p>Create a profile with your name and photo to send messages.</p><input id="nameInput" type="text" placeholder="Your Name" /><label for="avatarFile" class="avatar-upload-label" id="avatarUploadText">Upload a Photo</label><input id="avatarFile" type="file" accept="image/*" style="display:none"/><button id="createProfileBtn">Create Profile</button><div id="uploading" style="color:var(--text-muted);font-size:12px;margin-top:8px;display:none;">Uploading...</div></div></div>
  <div class="modal-overlay" id="gifModal"><div class="modal-content"><input type="text" id="gifSearchInput" placeholder="Search for GIFs..."><div id="gifResults"></div></div></div>
  <div class="modal-overlay" id="lightbox"><div class="modal-content"><img id="lightboxImage" src=""><button id="lightboxClose">&times;</button></div></div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = { apiKey: "AIzaSyD_HBGuQSh_GzqrHqHbgdaoBikLZsK3Qqs", authDomain: "new-all-f99f7.firebaseapp.com", databaseURL: "https://new-all-f99f7-default-rtdb.firebaseio.com", projectId: "new-all-f99f7", storageBucket: "new-all-f99f7.firebasestorage.app", messagingSenderId: "1069748173900", appId: "1:1069748173900:web:158d6336c0f4628133c8e9", measurementId: "G-V6DZ37WSBF" };
    const IMGBB_API_KEY = "4f29b88d8207f6e762c2c852d5c895f8";
    const GIPHY_API_KEY = "xPWo2aNJSvVnu8RFJZdMi1QycA6FL4lW"; // এখানে আপনার Giphy API কী দিন
    const PROFILE_KEY = 'livechat_profile_v7';
    const IMAGE_AD_DURATION = 30000; // 10 seconds for image ads
    
    firebase.initializeApp(firebaseConfig);
    const firestore = firebase.firestore();
    const rdb = firebase.database();

    const getEl = id => document.getElementById(id);
    const elements = {
      videoWrapper: getEl('videoWrapper'), videoPlayer: getEl('videoPlayer'), adIndicator: getEl('adIndicator'),
      adImageContainer: getEl('adImageContainer'), liveIndicator: getEl('liveIndicator'),
      messagesBox: getEl('messagesBox'), msgInput: getEl('msgInput'),
      sendBtn: getEl('sendBtn'), heartBtn: getEl('heartBtn'), viewerCountEl: getEl('viewerCount'),
      profileModal: getEl('profileModal'), imageUploadBtn: getEl('imageUploadBtn'), gifBtn: getEl('gifBtn'),
      imageInput: getEl('imageInput'), imagePreviewBox: getEl('imagePreviewBox'), avatarFile: getEl('avatarFile'),
      profileStatusBox: getEl('profileStatusBox'), createProfileBtn: getEl('createProfileBtn'),
      uploadingText: getEl('uploading'), serverSelectionBox: getEl('serverSelection'),
      gifModal: getEl('gifModal'), gifSearchInput: getEl('gifSearchInput'), gifResults: getEl('gifResults'),
      lightbox: getEl('lightbox'), lightboxImage: getEl('lightboxImage'), lightboxClose: getEl('lightboxClose'),
      typingIndicator: getEl('typingIndicator'),
      playOverlay: getEl('playOverlay') // নতুন প্লে ওভারলে এলিমেন্ট
    };
    
    let profile = JSON.parse(localStorage.getItem(PROFILE_KEY) || 'null');
    let selectedImageFile = null; let hls; let controlsTimeout; let typingTimeout; let imageAdTimeout;
    let state = { isAdPlaying: false, currentLiveUrl: null, currentAdData: null };
    let userHasInteracted = false; // নতুন ভ্যারিয়েবল ব্যবহারকারীর ইন্টারঅ্যাকশন ট্র্যাক করার জন্য

    // --- Core Initializations ---
    document.addEventListener('DOMContentLoaded', () => {
      initVideoPlayer(); initChat(); initModals();
      listenForServers(); listenForAds(); listenForTyping();
      setupPresence();
    });
    
    // --- নতুন ফাংশন: প্রথম প্লে হ্যান্ডেল করার জন্য ---
    function handleFirstPlay() {
      if (userHasInteracted) return; // শুধু একবারই রান হবে
      userHasInteracted = true;
      
      elements.videoPlayer.muted = false; // ভিডিও আনমিউট করুন
      elements.videoPlayer.play().catch(e => console.warn("Play after interaction failed:", e));
      elements.playOverlay.classList.add('hidden'); // ওভারলে লুকিয়ে ফেলুন
    }

    // --- Video Player & Ads Logic ---
    function initVideoPlayer() {
      getEl('fullscreenBtn').addEventListener('click', toggleFullscreen);
      elements.videoWrapper.addEventListener('mousemove', showControls);
      elements.videoWrapper.addEventListener('mouseleave', () => {
        clearTimeout(controlsTimeout);
        elements.videoWrapper.classList.remove('controls-visible');
      });
      elements.videoPlayer.addEventListener('waiting', () => elements.videoWrapper.classList.add('loading'));
      ['canplay', 'playing', 'error'].forEach(evt => elements.videoPlayer.addEventListener(evt, () => elements.videoWrapper.classList.remove('loading')));
      elements.videoPlayer.addEventListener('ended', handleVideoEnd);

      // প্লে ওভারলেতে ক্লিক ইভেন্ট যোগ করুন
      elements.playOverlay.addEventListener('click', handleFirstPlay);
    }
    
    function handleVideoEnd() {
        if (state.isAdPlaying && state.currentAdData.type === 'video') {
            advancePlaylist();
        }
    }

    function advancePlaylist() {
        const { playlist, currentIndex } = state.currentAdData.playlistData;
        const nextIndex = (currentIndex + 1) % playlist.length;
        rdb.ref('advertisement/currentIndex').set(nextIndex);
    }

    function toggleFullscreen() {
        const container = document.querySelector('.video-container');
        if (!document.fullscreenElement) {
            container.requestFullscreen().catch(err => alert(`Fullscreen error: ${err.message}`));
            if (screen.orientation?.lock) screen.orientation.lock('landscape').catch(() => {});
        } else {
            document.exitFullscreen();
            if (screen.orientation?.unlock) screen.orientation.unlock();
        }
    }

    function showControls() {
        elements.videoWrapper.classList.add('controls-visible');
        clearTimeout(controlsTimeout);
        controlsTimeout = setTimeout(() => elements.videoWrapper.classList.remove('controls-visible'), 3000);
    }

    function listenForServers() {
        rdb.ref('servers').on('value', snapshot => {
            const servers = snapshot.val() || {};
            const serverList = Object.keys(servers).map(key => ({...servers[key]}));
            elements.serverSelectionBox.innerHTML = '<span>Servers:</span>';
            if (serverList.length === 0) {
                elements.serverSelectionBox.innerHTML += '<span>No servers available.</span>'; return;
            }
            
            let activeUrl = document.querySelector('.server-btn.active')?.dataset.url;
            serverList.forEach(server => {
                const button = document.createElement('button');
                button.className = 'server-btn';
                button.textContent = server.name;
                button.dataset.url = server.url;
                if(server.url === activeUrl) button.classList.add('active');
                button.addEventListener('click', () => {
                    if (state.isAdPlaying) return;
                    document.querySelector('.server-btn.active')?.classList.remove('active');
                    button.classList.add('active');
                    loadSource(server.url);
                });
                elements.serverSelectionBox.appendChild(button);
            });
            if (!activeUrl && !state.isAdPlaying && elements.serverSelectionBox.querySelector('.server-btn')) {
              elements.serverSelectionBox.querySelector('.server-btn').click();
            }
        });
    }

    // --- loadSource ফাংশনটি আপডেট করা হয়েছে ---
    function loadSource(url, isLiveStream = true) {
        if (isLiveStream) {
            state.currentLiveUrl = url;
        }
        elements.videoWrapper.classList.add('loading');
        if (hls) {
            hls.destroy();
        }

        // ব্যবহারকারী ক্লিক করে থাকলে তবেই ভিডিও আনমিউট হবে
        if (userHasInteracted) {
            elements.videoPlayer.muted = false;
        }

        if (isLiveStream && Hls.isSupported() && url.includes('.m3u8')) {
            hls = new Hls();
            hls.loadSource(url);
            hls.attachMedia(elements.videoPlayer);
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                elements.videoPlayer.play().catch(e => {
                    console.error("HLS Playback Error:", e);
                    // প্লে না হলে ওভারলে আবার দেখান
                    if (!userHasInteracted) {
                        elements.playOverlay.classList.remove('hidden');
                    }
                });
            });
        } else {
            elements.videoPlayer.src = url;
            elements.videoPlayer.play().catch(e => {
                console.error("Direct Playback Error:", e);
                // প্লে না হলে ওভারলে আবার দেখান
                if (!userHasInteracted) {
                    elements.playOverlay.classList.remove('hidden');
                }
            });
        }
    }

    function listenForAds() {
        rdb.ref('advertisement').on('value', snapshot => {
            const adData = snapshot.val();
            if (adData && adData.isActive && adData.playlist?.length > 0) {
                const currentAd = adData.playlist[adData.currentIndex];
                state.currentAdData = { ...currentAd, playlistData: adData };
                playAd(currentAd);
            } else if (state.isAdPlaying) {
                restoreLiveStream();
            }
        });
    }

    function playAd(ad) {
        if (!state.isAdPlaying) {
            // elements.videoPlayer.pause(); // pause করার প্রয়োজন নেই, loadSource এটি হ্যান্ডেল করবে
            if (hls) hls.destroy();
        }
        state.isAdPlaying = true;
        clearTimeout(imageAdTimeout);
        
        elements.liveIndicator.style.display = 'none';
        elements.adIndicator.style.display = 'block';
        elements.adIndicator.textContent = `Ad: ${ad.name}`;

        if (ad.type === 'video') {
            elements.adImageContainer.style.display = 'none';
            elements.videoPlayer.style.display = 'block';
            loadSource(ad.url, false);
        } else { // Image ad
            elements.videoPlayer.style.display = 'none';
            elements.videoPlayer.pause();
            elements.adImageContainer.style.backgroundImage = `url(${ad.url})`;
            elements.adImageContainer.style.display = 'block';
            imageAdTimeout = setTimeout(advancePlaylist, IMAGE_AD_DURATION);
        }
    }

    function restoreLiveStream() {
      state.isAdPlaying = false;
      clearTimeout(imageAdTimeout);
      
      elements.adIndicator.style.display = 'none';
      elements.liveIndicator.style.display = 'flex';
      elements.adImageContainer.style.display = 'none';
      elements.videoPlayer.style.display = 'block';

      if (state.currentLiveUrl) {
        loadSource(state.currentLiveUrl, true);
      }
    }

    // --- বাকি জাভাস্ক্রিপ্ট কোড অপরিবর্তিত ---
    
    // --- Chat Logic ---
    function initChat() {
      renderProfileStatus();
      elements.msgInput.addEventListener('focus', () => { if (!profile) elements.profileModal.style.display = 'flex'; });
      elements.msgInput.addEventListener('input', () => {
        updateSendButtonState();
        clearTimeout(typingTimeout);
        if(profile && elements.msgInput.value.trim()) {
          rdb.ref('/typing/' + profile.uid).set(profile.name);
          typingTimeout = setTimeout(() => rdb.ref('/typing/' + profile.uid).remove(), 2000);
        }
      });
      elements.sendBtn.addEventListener('click', sendMessage);
      elements.msgInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); sendMessage(); } });
      elements.imageUploadBtn.onclick = () => { if (!profile) elements.profileModal.style.display = 'flex'; else elements.imageInput.click(); };
      elements.imageInput.onchange = e => {
        selectedImageFile = e.target.files[0];
        if (selectedImageFile) {
          elements.imagePreviewBox.innerHTML = `<div class="image-preview"><img src="${URL.createObjectURL(selectedImageFile)}"><span class="filename">${escapeHtml(selectedImageFile.name)}</span><button onclick="cancelImageUpload()">&times;</button></div>`;
        }
        updateSendButtonState();
      };
      firestore.collection('chats').orderBy('createdAt', 'desc').limit(50).onSnapshot(handleNewMessages);
    }

    const updateSendButtonState = () => {
        const hasContent = elements.msgInput.value.trim() || selectedImageFile;
        elements.sendBtn.classList.toggle('visible', hasContent);
        elements.heartBtn.classList.toggle('hidden', hasContent);
    };

    window.cancelImageUpload = () => { 
        selectedImageFile = null; elements.imageInput.value = ''; 
        elements.imagePreviewBox.innerHTML = ''; updateSendButtonState();
    };

    async function sendMessage() {
      if (!profile) return;
      const text = elements.msgInput.value.trim();
      if (!text && !selectedImageFile) return;
      const [tempImage, tempText] = [selectedImageFile, text];
      elements.msgInput.value = ''; cancelImageUpload();
      rdb.ref('/typing/' + profile.uid).remove();

      try {
        let imageUrl = null;
        if (tempImage) imageUrl = await uploadToImgbb(tempImage);
        const messageData = { ...profile, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
        if (tempText) messageData.text = tempText;
        if (imageUrl) messageData.imageUrl = imageUrl;
        await firestore.collection('chats').add(messageData);
      } catch (e) { console.error("Send failed:", e); }
    }
    
    function handleNewMessages(snapshot) {
      const isScrolledToBottom = elements.messagesBox.scrollHeight - elements.messagesBox.clientHeight <= elements.messagesBox.scrollTop + 100;
      elements.messagesBox.innerHTML = snapshot.docs.reverse().map(doc => {
        const data = doc.data();
        const time = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
        return `<div class="message"><img src="${data.avatar}" alt="avatar" class="avatar"><div class="content"><div class="metadata"><div class="name">${escapeHtml(data.name)}</div><div class="time">${time}</div></div>${data.imageUrl ? `<img src="${data.imageUrl}" class="chat-image" onclick="openLightbox('${data.imageUrl}')">` : ''}${data.text ? `<div class="text">${escapeHtml(data.text)}</div>` : ''}</div></div>`;
      }).join('');
      if(isScrolledToBottom) elements.messagesBox.scrollTop = elements.messagesBox.scrollHeight;
    }
    
    // --- GIF & Modals Logic ---
    function initModals() {
      elements.gifBtn.onclick = () => { if (!profile) elements.profileModal.style.display = 'flex'; else openGifModal(); };
      elements.gifModal.onclick = (e) => { if (e.target === elements.gifModal) elements.gifModal.style.display = 'none'; };
      elements.gifSearchInput.addEventListener('input', debounce(() => searchGifs(elements.gifSearchInput.value), 300));
      elements.lightbox.onclick = (e) => { if (e.target !== elements.lightboxImage) elements.lightbox.style.display = 'none'; };
    }

    async function openGifModal() {
      if (!GIPHY_API_KEY || GIPHY_API_KEY === "YOUR_GIPHY_API_KEY") {
        return alert("Giphy API Key is not configured.");
      }
      elements.gifModal.style.display = 'flex';
      elements.gifResults.innerHTML = '<div class="video-loader" style="display:block; position:relative; margin:auto;"></div>';
      const response = await fetch(`https://api.giphy.com/v1/gifs/trending?api_key=${GIPHY_API_KEY}&limit=30`);
      const json = await response.json();
      renderGifs(json.data);
    }

    async function searchGifs(query) {
      const endpoint = query ? `search?q=${encodeURIComponent(query)}&` : 'trending?';
      const response = await fetch(`https://api.giphy.com/v1/gifs/${endpoint}api_key=${GIPHY_API_KEY}&limit=30`);
      const json = await response.json();
      renderGifs(json.data);
    }
    
    function renderGifs(gifs) {
        elements.gifResults.innerHTML = gifs.map(gif => `<img src="${gif.images.fixed_width.url}" alt="${gif.title}" data-full-url="${gif.images.original.url}">`).join('');
        elements.gifResults.querySelectorAll('img').forEach(img => {
            img.onclick = () => {
                sendGif(img.dataset.fullUrl);
                elements.gifModal.style.display = 'none';
            };
        });
    }

    async function sendGif(gifUrl) {
      if (!profile) return;
      await firestore.collection('chats').add({
        ...profile,
        imageUrl: gifUrl,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    
    window.openLightbox = (url) => {
        elements.lightboxImage.src = url;
        elements.lightbox.style.display = 'flex';
    };

    // --- User Profile & Presence ---
    function renderProfileStatus() {
      if (profile) {
        elements.profileStatusBox.innerHTML = `<div class="profile-status"><img src="${profile.avatar}"><span class="name">As <strong>${escapeHtml(profile.name)}</strong></span><button onclick="signOut()" title="Sign Out">&times;</button></div>`;
      } else {
        elements.profileStatusBox.innerHTML = '';
      }
    }
    
    window.signOut = () => {
      if (confirm('Are you sure you want to sign out?')) {
        if(profile) rdb.ref('/typing/' + profile.uid).remove();
        profile = null;
        localStorage.removeItem(PROFILE_KEY);
        renderProfileStatus();
      }
    };
    
    elements.createProfileBtn.onclick = async () => {
      const name = getEl('nameInput').value.trim();
      const file = elements.avatarFile.files[0];
      if (!name || !file) return alert('Please provide both name and photo.');
      
      elements.uploadingText.style.display = 'block';
      elements.createProfileBtn.disabled = true;
      try {
        const avatarUrl = await uploadToImgbb(file);
        profile = { uid: 'u_' + Date.now(), name, avatar: avatarUrl };
        localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
        elements.profileModal.style.display = 'none';
        renderProfileStatus();
      } catch (e) {
        alert("Profile creation failed."); console.error(e);
      } finally {
        elements.uploadingText.style.display = 'none';
        elements.createProfileBtn.disabled = false;
      }
    };

    function setupPresence() {
      const uid = (profile?.uid) || (localStorage.getItem('livechat_presence_uid') || 'guest_' + Date.now());
      localStorage.setItem('livechat_presence_uid', uid);
      const userStatusRef = rdb.ref('/presence/' + uid);
      rdb.ref('.info/connected').on('value', snap => {
        if (snap.val()) { 
          userStatusRef.onDisconnect().remove();
          userStatusRef.set(true); 
          if(profile) rdb.ref('/typing/' + profile.uid).onDisconnect().remove();
        }
      });
      rdb.ref('presence').on('value', snap => { elements.viewerCountEl.textContent = `● ${snap.numChildren()} watching`; });
    }

    function listenForTyping() {
      rdb.ref('/typing').on('value', snap => {
        const typers = snap.val() || {};
        const activeTypers = Object.keys(typers)
          .filter(uid => uid !== profile?.uid)
          .map(uid => escapeHtml(typers[uid]));
        
        if(activeTypers.length > 0) {
          let text = activeTypers.slice(0, 2).join(', ') + (activeTypers.length > 2 ? ' and others' : '');
          text += (activeTypers.length > 1 ? ' are' : ' is') + ' typing...';
          elements.typingIndicator.textContent = text;
          elements.typingIndicator.classList.add('visible');
        } else {
          elements.typingIndicator.classList.remove('visible');
        }
      });
    }

    // --- Utilities ---
    async function uploadToImgbb(file) {
      const formData = new FormData(); formData.append('image', file);
      const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
      const data = await res.json();
      if (!data.success) throw new Error(data.error.message);
      return data.data.url;
    }
    function escapeHtml(str) {
      return str?.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]) || '';
    }
    const debounce = (func, delay) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func(...args), delay); }; };
  </script>
</body>
</html>
