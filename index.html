<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIVE Hub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-darker: #0f172a; --bg-dark: #1e293b; --bg-medium: #334155;
      --text-light: #e2e8f0; --text-muted: #94a3b8; --accent: #38bdf8;
      --danger: #f43f5e; --live-red: #ef4444; --font-family: 'Poppins', sans-serif;
      --success: #22c55e; --gift-bg: #4f46e5; --admin-color: #f59e0b;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; overflow: hidden; margin: 0; background-color: var(--bg-darker); }
    body { 
      color: var(--text-light); font-family: var(--font-family); 
      display: flex; flex-direction: column;
    }
    .video-container { flex-shrink: 0; background-color: #000; width: 100%; line-height: 0; position: relative; }
    .app-container { display: flex; flex-direction: column; flex-grow: 1; max-width: 800px; width: 100%; margin: 0 auto; background-color: var(--bg-darker); overflow: hidden; }
    .video-wrapper { position: relative; background-color: #000; overflow: hidden; width: 100%; aspect-ratio: 16 / 9; max-height: 75vh; display: flex; align-items: center; justify-content: center; transition: background-color 0.3s ease; }
    .video-wrapper.menu-active { background: linear-gradient(135deg, #0f172a, #1e293b); }
    .video-wrapper video, .video-wrapper iframe, .video-wrapper audio { width: 100%; height: 100%; object-fit: contain; display: block; border: none; }
    .video-loader { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; border: 5px solid rgba(255, 255, 255, 0.3); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; transform: translate(-50%, -50%); z-index: 10; display: none; }
    .video-wrapper.loading .video-loader { display: block; }
    @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
    #menuContainer, #youtubeContainer, #gameContainer { display: none; }
    #menuContainer.active, #youtubeContainer.active, #gameContainer.active { display: flex; }
    #menuContainer { gap: 15px; flex-wrap: wrap; justify-content: center; align-items: center; padding: 20px; width: 100%; height: 100%; }
    .menu-btn { background-color: var(--bg-dark); border: 1px solid var(--bg-medium); border-radius: 12px; color: var(--text-light); cursor: pointer; padding: 15px; text-align: center; transition: all 0.2s ease; width: 130px; }
    .menu-btn:hover { background-color: var(--bg-medium); transform: translateY(-5px); }
    .menu-btn svg { width: 40px; height: 40px; fill: var(--accent); margin-bottom: 10px; }
    .menu-btn span { font-size: 14px; font-weight: 500; display: block; }
    #youtubeContainer { width: 100%; height: 100%; background-color: var(--bg-darker); flex-direction: column; padding: 16px; }
    #youtubeSearchBox { display: flex; gap: 10px; margin-bottom: 16px; }
    #youtubeSearchBox input { flex-grow: 1; background-color: var(--bg-dark); border: 1px solid var(--bg-medium); color: var(--text-light); padding: 10px 15px; border-radius: 8px; }
    #youtubeSearchBox button { background-color: var(--accent); border: none; color: var(--bg-darker); padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    #youtubeResults { flex-grow: 1; overflow-y: auto; }
    .youtube-item { display: flex; gap: 12px; align-items: center; cursor: pointer; padding: 8px; border-radius: 8px; transition: background-color 0.2s; }
    .youtube-item:hover { background-color: var(--bg-dark); }
    .youtube-item img { width: 120px; height: 67px; object-fit: cover; border-radius: 6px; }
    .youtube-item .title { font-size: 14px; font-weight: 500; }
    #backToMenuBtn { position: absolute; top: 15px; left: 15px; background-color: rgba(0,0,0,0.6); border: none; color: white; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; z-index: 50; display: none; align-items: center; justify-content: center; }
    .online-users-container { padding: 12px 16px; background-color: var(--bg-dark); display: flex; gap: 14px; align-items: center; overflow-x: auto; flex-shrink: 0; border-bottom: 1px solid var(--bg-medium); min-height: 68px; }
    .online-users-container::-webkit-scrollbar { height: 5px; } .online-users-container::-webkit-scrollbar-track { background: transparent; } .online-users-container::-webkit-scrollbar-thumb { background: var(--bg-medium); border-radius: 10px; }
    .online-user-avatar { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); flex-shrink: 0; transition: all 0.2s ease-in-out; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    .online-user-avatar:hover { transform: scale(1.1); border-color: #fff; }
    .online-user-avatar.speaking { transform: scale(1.15); box-shadow: 0 0 15px 4px var(--success); border-color: var(--success); }
    #audioStreamsContainer { display: none; }
    .chat-wrapper { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
    .chat-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; background-color: var(--bg-dark); border-bottom: 1px solid var(--bg-medium); flex-shrink: 0; } .chat-header h1 { font-size: 16px; margin: 0; font-weight: 600; } .viewer-count { font-size: 14px; color: var(--text-muted); }
    .messages-box { flex-grow: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 16px; scroll-behavior: smooth; }
    .scroll-to-bottom-btn { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background-color: var(--accent); color: var(--bg-darker); border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; font-weight: 600; cursor: pointer; z-index: 20; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: opacity 0.3s, transform 0.3s; opacity: 0; visibility: hidden; }
    .scroll-to-bottom-btn.visible { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
    .message { display: flex; gap: 12px; align-items: flex-start; max-width: 90%; animation: slideInUp 0.4s ease-out; }
    .message.gift-message, .message.notification-message, .message.poll-message, .message.game-message { max-width: 100%; }
    @keyframes slideInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    .message img.avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; flex-shrink: 0; cursor: pointer; }
    .message .content { background-color: var(--bg-dark); padding: 8px 12px; border-radius: 12px; border-top-left-radius: 0; max-width: 100%; }
    .message .metadata { display: flex; align-items: baseline; gap: 8px; margin-bottom: 4px; }
    .message .metadata .name { font-weight: 600; font-size: 13px; color: var(--accent); cursor: pointer; }
    .message .metadata .name.admin { color: var(--admin-color); }
    .message .metadata .name.admin::after { content: ' ★'; font-size: 12px; }
    .message .metadata .time { font-size: 11px; color: var(--text-muted); }
    .message .content .text { font-size: 15px; color: var(--text-light); line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
    .message .content .text .mention { background-color: hsla(205, 87%, 56%, 0.2); color: var(--accent); padding: 1px 4px; border-radius: 4px; font-weight: 600; }
    .message .content .chat-image { max-width: 100%; border-radius: 8px; margin-top: 8px; display: block; cursor: pointer; }
    .reply-quote { background-color: var(--bg-darker); border-left: 3px solid var(--accent); padding: 6px 10px; margin-bottom: 8px; border-radius: 4px; font-size: 13px; opacity: 0.8; }
    .reply-quote .author { font-weight: 600; color: var(--text-muted); }
    .reply-quote .text-snippet { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
    .gift-message .content { background: linear-gradient(45deg, #fde047, #f97316); color: #1e293b; width: 100%; text-align: center; border-radius: 8px; padding: 12px; }
    .gift-message .text { font-weight: 600; font-size: 16px; }
    .notification-message .content, .game-message .content { background-color: var(--bg-medium); color: var(--text-light); width: 100%; text-align: center; border-radius: 8px; font-size: 13px; font-style: italic; }
    .poll-message { width: 100%; flex-direction: column; align-items: center; }
    .poll-message .content { background-color: var(--bg-darker); border: 1px solid var(--bg-medium); width: 100%; padding: 16px; border-radius: 12px; }
    .poll-question { font-size: 16px; font-weight: 600; margin-bottom: 12px; text-align: center; }
    .poll-option { background-color: var(--bg-dark); border: 1px solid var(--bg-medium); border-radius: 8px; padding: 10px; margin-bottom: 8px; cursor: pointer; position: relative; overflow: hidden; transition: border-color 0.3s; }
    .poll-option:hover { border-color: var(--accent); }
    .poll-option.voted-by-me { border-color: var(--success); font-weight: bold; }
    .poll-option .progress { background-color: var(--accent); position: absolute; top: 0; left: 0; height: 100%; opacity: 0.2; z-index: 1; transition: width 0.5s ease; }
    .poll-option .text-content { position: relative; z-index: 2; display: flex; justify-content: space-between; }
    .poll-option .percentage { font-weight: 600; }
    .input-wrapper { flex-shrink: 0; background-color: var(--bg-dark); }
    #imagePreviewBox, #profileStatusBox, #replyPreviewBox { padding: 0 16px; }
    #replyPreviewBox { padding-top: 8px; }
    .input-area { display: flex; gap: 8px; align-items: center; padding: 12px 16px; position: relative; }
    .icon-btn { background: none; border: none; cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: center; border-radius: 50%; flex-shrink: 0; }
    .icon-btn:hover { background-color: rgba(255,255,255,0.1); }
    .icon-btn svg { width: 24px; height: 24px; fill: var(--text-muted); }
    #mentionSuggestions { position: absolute; bottom: 100%; left: 16px; right: 16px; background: var(--bg-darker); border: 1px solid var(--bg-medium); border-radius: 8px; max-height: 150px; overflow-y: auto; z-index: 100; display: none; }
    .mention-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; cursor: pointer; }
    .mention-item:hover, .mention-item.selected { background-color: var(--bg-medium); }
    .mention-item img { width: 24px; height: 24px; border-radius: 50%; }
    .mention-item span { font-size: 14px; }
    #adminPanelBtn { position: fixed; bottom: 80px; right: 20px; background-color: var(--admin-color); color: var(--bg-darker); border: none; border-radius: 50%; width: 50px; height: 50px; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; cursor: pointer; }
    #adminPanelBtn svg { width: 28px; height: 28px; fill: currentColor; }
    #gameContainer { flex-direction: column; align-items: center; justify-content: center; gap: 20px; color: var(--text-light); }
    #ticTacToeBoard { display: grid; grid-template-columns: repeat(3, 80px); grid-template-rows: repeat(3, 80px); gap: 10px; }
    .ttt-cell { width: 80px; height: 80px; background-color: var(--bg-dark); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: bold; cursor: pointer; }
    .ttt-cell:hover { background-color: var(--bg-medium); }
    #gameStatus { font-size: 18px; font-weight: 500; }
    #resetGameBtn { padding: 8px 16px; border-radius: 8px; background-color: var(--danger); border: none; color: white; cursor: pointer; font-weight: 600; margin-top: 10px; }
    .typing-indicator { position: absolute; bottom: 75px; left: 16px; font-size: 13px; color: var(--text-muted); font-style: italic; background: var(--bg-dark); padding: 4px 10px; border-radius: 10px; z-index: 10; opacity: 0; transition: opacity 0.3s; } .typing-indicator.visible { opacity: 1; }
    .image-preview, .profile-status, .reply-preview { display: flex; align-items: center; gap: 10px; background-color: var(--bg-darker); border-radius: 8px; padding: 8px; margin-top: 8px; }
    .image-preview img, .profile-status img { height: 40px; width: 40px; object-fit: cover; border-radius: 4px; }
    .image-preview .filename, .profile-status .name, .reply-preview .name { font-size: 13px; color: var(--text-muted); font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .image-preview button, .profile-status button.signout-btn, .reply-preview button { background: var(--danger); color: white; border: none; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; cursor: pointer; line-height: 22px; text-align: center; margin-left: auto; flex-shrink: 0; }
    .wallet-info { display: flex; align-items: center; gap: 10px; margin-left: auto; } .wallet-info .balance { font-size: 14px; font-weight: 600; color: var(--success); } .withdraw-btn { background-color: var(--success); color: #fff; border: none; border-radius: 6px; padding: 4px 10px; font-size: 12px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 4px; } .withdraw-btn.locked { background-color: var(--bg-medium); cursor: not-allowed; color: var(--text-muted); } .withdraw-btn svg { width: 14px; height: 14px; fill: currentColor; }
    .input-field { flex-grow: 1; min-width: 0; } .right-icons { position: relative; display: flex; align-items: center; } input[type="text"] { width: 100%; border: 1px solid var(--bg-medium); background-color: var(--bg-darker); border-radius: 20px; padding: 10px 16px; color: var(--text-light); font-size: 15px; font-family: var(--font-family); } input[type="text"]:focus { outline: none; border-color: var(--accent); }
    #sendBtn { transform: scale(0); transition: transform 0.2s ease; } #sendBtn.visible { transform: scale(1); } #heartBtn { display: inline-flex; } #heartBtn.hidden { transform: scale(0); }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal-content { background-color: var(--bg-dark); padding: 24px; border-radius: 16px; width: 90%; max-width: 420px; border: 1px solid var(--bg-medium); transform: scale(0.95); animation: scaleIn 0.3s ease forwards; }
    @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .modal-content h2 { margin-top: 0; font-size: 20px; font-weight: 600; text-align: center; } .modal-content p { color: var(--text-muted); font-size: 14px; margin-bottom: 20px; text-align: center; }
    .modal-content input, .modal-content textarea { width: 100%; padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 1px solid var(--bg-medium); background: var(--bg-darker); color: #fff; font-family: var(--font-family); resize: vertical; }
    .modal-content button { width: 100%; cursor: pointer; border: 0; padding: 12px; border-radius: 8px; background: var(--accent); color: var(--bg-darker); font-weight: 600; font-size: 16px; }
    .modal-content button:disabled { background-color: var(--bg-medium); cursor: not-allowed; }
    #avatarPreview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin: 0 auto 16px; display: none; border: 2px solid var(--bg-medium); } .avatar-upload-label { display: block; padding: 12px; border-radius: 8px; border: 2px dashed var(--bg-medium); cursor: pointer; margin-bottom: 12px; color: var(--text-muted); text-align: center; } .avatar-upload-label:hover { border-color: var(--accent); color: var(--accent); }
    #giftModal .modal-content, #radioModal .modal-content { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; text-align: center; }
    .gift-item, .radio-station { background: var(--bg-darker); padding: 15px; border-radius: 12px; cursor: pointer; transition: transform 0.2s; }
    .gift-item:hover, .radio-station:hover { transform: scale(1.05); background: var(--bg-medium); }
    .gift-item img, .radio-station img { width: 50px; height: 50px; object-fit: contain; margin-bottom: 8px; pointer-events: none; }
    .gift-item .cost, .radio-station .name { font-size: 13px; font-weight: 600; color: var(--success); pointer-events: none; }
    .radio-station .name { color: var(--text-light); }
    #userProfileModal .modal-content { padding: 30px; text-align: center; }
    #userProfileModal img { width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--accent); margin-bottom: 15px; }
    #userProfileModal h3 { margin: 0 0 5px 0; font-size: 22px; }
    #userProfileModal p { margin: 0; font-size: 14px; color: var(--text-muted); word-break: break-all; }
    #userProfileModal .stats { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
    #userProfileModal .stat-item { text-align: center; }
    #userProfileModal .stat-item .value { font-size: 18px; font-weight: 600; }
    #userProfileModal .stat-item .label { font-size: 12px; color: var(--text-muted); }
    #sendGiftBtn { margin-top: 20px; background: var(--gift-bg); color: #fff; }
  </style>
</head>
<body>

  <div class="video-container">
    <div class="online-users-container" id="onlineUsersContainer"><span>Loading...</span></div>
    <div class="video-wrapper" id="videoWrapper">
      <div class="video-loader"></div>
      <div id="menuContainer" class="active">
        <button class="menu-btn" data-action="playVideo"><svg viewBox="0 0 24 24"><path d="M10,16.5V7.5L16,12M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/></svg><span>Play Video</span></button>
        <button class="menu-btn" data-action="playYoutube"><svg viewBox="0 0 24 24"><path d="M21.582,6.186c-0.23-0.86-0.908-1.538-1.768-1.768C18.25,4,12,4,12,4S5.75,4,4.186,4.418 C3.326,4.648,2.648,5.326,2.418,6.186C2,7.75,2,12,2,12s0,4.25,0.418,5.814c0.23,0.86,0.908,1.538,1.768,1.768 C5.75,20,12,20,12,20s6.25,0,7.814-0.418c0.86-0.23,1.538-0.908,1.768-1.768C22,16.25,22,12,22,12S22,7.75,21.582,6.186z M10,15.464V8.536L16,12L10,15.464z"/></svg><span>YouTube</span></button>
        <button class="menu-btn" data-action="playRadio"><svg viewBox="0 0 24 24"><path d="M3,9V15H7L12,20V4L7,9H3M16.5,12C16.5,10.23 15.5,8.71 14,7.97V16C15.5,15.29 16.5,13.76 16.5,12M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.84 14,18.7V20.77C18,19.86 21,16.28 21,12C21,7.72 18,4.14 14,3.23Z"/></svg><span>Radio</span></button>
        <button class="menu-btn" data-action="playGame"><svg viewBox="0 0 24 24"><path d="M19,2H5A2,2 0 0,0 3,4V20A2,2 0 0,0 5,22H19A2,2 0 0,0 21,20V4A2,2 0 0,0 19,2M15,13H13V15H11V13H9V11H11V9H13V11H15M17.5,17.5L16,16L14.5,17.5L13,16L14.5,14.5L13,13L14.5,11.5L13,10L14.5,8.5L13,7L14.5,5.5L16,7L17.5,5.5L19,7L17.5,8.5L19,10L17.5,11.5L19,13L17.5,14.5L19,16M9.5,17.5L8,16L6.5,17.5L5,16L6.5,14.5L5,13L6.5,11.5L5,10L6.5,8.5L5,7L6.5,5.5L8,7L9.5,5.5L11,7L9.5,8.5L11,10L9.5,11.5L11,13L9.5,14.5L11,16L9.5,17.5Z"/></svg><span>Game</span></button>
      </div>
      <div id="youtubeContainer">
          <div id="youtubeSearchBox">
              <input type="text" id="youtubeQuery" placeholder="Search on YouTube...">
              <button id="youtubeSearchBtn">Search</button>
          </div>
          <div id="youtubeResults"></div>
      </div>
      <div id="gameContainer">
          <h2 id="gameStatus">Tic-Tac-Toe</h2>
          <div id="ticTacToeBoard"></div>
          <button id="resetGameBtn" style="display:none;">Reset Game</button>
      </div>
      <video id="videoPlayer" playsinline controls style="display:none;"></video>
      <audio id="audioPlayer" playsinline controls style="display:none;"></audio>
      <button id="backToMenuBtn"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg></button>
    </div>
  </div>

  <div class="app-container">
    <div class="chat-wrapper">
      <header class="chat-header"><h1>Live Chat</h1><div class="viewer-count" id="viewerCount">● 0 watching</div></header>
      <div class="messages-box" id="messagesBox"></div>
      <button id="scrollToBottomBtn" class="scroll-to-bottom-btn">↓ New Messages</button>
      <div class="typing-indicator" id="typingIndicator"></div>
      <div class="input-wrapper">
        <div id="mentionSuggestions"></div>
        <div id="profileStatusBox"></div>
        <div id="replyPreviewBox"></div>
        <div id="imagePreviewBox"></div>
        <div class="input-area">
          <button class="icon-btn" id="imageUploadBtn" title="Upload Image"><svg viewBox="0 0 24 24"><path d="M21.58,16.09L17.24,11.75C16.67,11.18 15.77,11.18 15.2,11.75L14.47,12.47L11.82,9.82C11.25,9.25 10.35,9.25 9.78,9.82L4.42,15.18C4.16,15.44 4,15.81 4,16.2V19C4,20.1 4.9,21 6,21H18C19.1,21 20,20.1 20,19V17.59C20,17.18 20.16,16.77 20.42,16.53L21.58,15.37C22.15,14.8 22.15,13.9 21.58,13.33M6,19L10.5,14.5L13.5,17.5L16.5,14.5L18,16V19H6M16,10C17.1,10 18,9.1 18,8C18,6.9 17.1,6 16,6C14.9,6 14,6.9 14,8C14,9.1 14.9,10 16,10M20,2H4C2.9,2 2,2.9 2,4V13.8C2,14.21 2.16,14.62 2.42,14.88L3.58,16.04C3,16.5 3,17.22 3,17.59V19C3,20.65 4.35,22 6,22H18C19.65,22 21,20.65 21,19V17.59C21.54,17.22 21.73,16.63 21.58,16.09L22.75,14.93C23.32,14.36 23.32,13.46 22.75,12.89L19,9L14.75,13.25L11.25,9.75L7,14L4,11V4H20V2Z"/></svg></button>
          <button class="icon-btn" id="giftBtn" title="Send a Gift"><svg viewBox="0 0 24 24" fill="var(--gift-bg)"><path d="M20 6H4V4H20V6M20.36 10.16L19 11.53V20H5V11.53L3.64 10.16C2.86 9.38 2.86 8.11 3.64 7.33L4.33 6.64C5.11 5.86 6.38 5.86 7.16 6.64L8 7.5L12 3.5L16 7.5L16.84 6.64C17.62 5.86 18.89 5.86 19.67 6.64L20.36 7.33C21.14 8.11 21.14 9.38 20.36 10.16Z"/></svg></button>
          <div class="input-field"><input type="text" id="msgInput" placeholder="Write a message..."></div>
          <input type="file" id="imageInput" accept="image/*" style="display:none;">
          <div class="right-icons">
            <button class="icon-btn hidden" id="heartBtn" title="React"><svg viewBox="0 0 24 24" fill="#ef4444"><path d="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z" /></svg></button>
            <button class="icon-btn" id="sendBtn" title="Send"><svg viewBox="0 0 24 24" fill="var(--accent)"><path d="M2,21L23,12L2,3V10L17,12L2,14V21Z" /></svg></button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="audioStreamsContainer"></div>
  <button id="adminPanelBtn"><svg viewBox="0 0 24 24"><path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" /></svg></button>

  <!-- Modals -->
  <div class="modal-overlay" id="profileModal"><div class="modal-content"><img id="avatarPreview" src="#" alt="Avatar Preview"/><h2>Join the Chat</h2><p>Create a profile to chat and talk.</p><input id="nameInput" type="text" placeholder="Your Name" /><label for="avatarFile" class="avatar-upload-label">Upload a Photo</label><input id="avatarFile" type="file" accept="image/*" style="display:none"/><button id="createProfileBtn">Create Profile</button><div id="uploading" style="display:none;color:var(--text-muted);font-size:12px;margin-top:8px;">Uploading...</div></div></div>
  <div class="modal-overlay" id="withdrawModal"><div class="modal-content"><h2>Withdraw Balance</h2><p>You can withdraw 20 BDT via Grameenphone mobile recharge. Enter your GP number (017... or 013...).</p><input id="withdrawNumberInput" type="tel" placeholder="e.g., 01700000000" /><button id="submitWithdrawBtn">Submit Request (20 BDT)</button></div></div>
  <div class="modal-overlay" id="lightbox" style="cursor: zoom-out;"><div class="modal-content" style="background: none; border: none; width: auto; height: auto; max-width: 90vw; max-height: 90vh; padding: 0;"><img id="lightboxImage" src="" style="max-width: 100%; max-height: 100%; object-fit: contain;"></div></div>
  <div class="modal-overlay" id="radioModal"><div class="modal-content" id="radioStationsContainer"><h2>Listen to Radio</h2><p>Select a station to start playing.</p></div></div>
  <div class="modal-overlay" id="giftModal"><div class="modal-content" id="giftOptionsContainer"><h2>Send a Gift</h2><p>Select a gift to send to <strong id="giftRecipientName">everyone</strong>.</p></div></div>
  <div class="modal-overlay" id="userProfileModal">
    <div class="modal-content">
      <img id="profileModalAvatar" src="">
      <h3 id="profileModalName"></h3>
      <p id="profileModalUid"></p>
      <div class="stats">
        <div class="stat-item"><div id="profileModalBalance" class="value">৳ 0</div><div class="label">Balance</div></div>
        <div class="stat-item"><div id="profileModalPoints" class="value">0</div><div class="label">Points</div></div>
      </div>
      <button id="sendGiftBtn">Send Gift</button>
    </div>
  </div>
  <div class="modal-overlay" id="adminModal">
    <div class="modal-content" style="text-align: left;">
      <h2>Admin Panel</h2>
      <button id="createPollBtn" style="margin-bottom: 20px; width:100%; cursor:pointer; border:0; padding:12px; border-radius:8px; background:var(--accent); color:var(--bg-darker); font-weight:600; font-size:16px;">Create New Poll</button>
      <div id="pollCreator" style="display:none; margin-top: 15px;">
        <input type="text" id="pollQuestion" placeholder="Poll Question">
        <textarea id="pollOptions" rows="4" placeholder="Options, one per line"></textarea>
        <button id="submitPollBtn">Start Poll</button>
      </div>
      <hr style="border-color: var(--bg-medium); margin: 20px 0;">
      <button id="shareScreenBtn" style="width:100%; cursor:pointer; border:0; padding:12px; border-radius:8px; background:var(--bg-medium); color:var(--text-light); font-weight:600; font-size:16px;">Share Screen</button>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = { apiKey: "AIzaSyD_HBGuQSh_GzqrHqHbgdaoBikLZsK3Qqs", authDomain: "new-all-f99f7.firebaseapp.com", databaseURL: "https://new-all-f99f7-default-rtdb.firebaseio.com", projectId: "new-all-f99f7", storageBucket: "new-all-f99f7.firebasestorage.app", messagingSenderId: "1069748173900", appId: "1:1069748173900:web:158d6336c0f4628133c8e9", measurementId: "G-V6DZ37WSBF" };
  const IMGBB_API_KEY = "4f29b88d8207f6e762c2c852d5c895f8";
  const YOUTUBE_API_KEY = "AIzaSyCFrCuHFk0LNylLnilq5zl-arWoSdil7OE";
  const PROFILE_KEY = 'livechat_profile_v10';
  const MIN_WITHDRAW_AMOUNT = 20;
  const RTC_CONFIGURATION = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
  const ADMIN_UID = "u_1757836017295_0491bxa";
  const RADIO_STATIONS = [ { name: "Radio Foorti", url: "https://listen.radiosimplified.com/foorti", logo: "https://i.ibb.co/L83f7Nn/Radio-Foorti-Logo-svg.png" }, { name: "ABC Radio", url: "http://stream.abcradiodhaka.fm:8000/abc", logo: "https://i.ibb.co/3pQx01p/abc-radio-logo.png" }];
  const VIRTUAL_GIFTS = [ { name: 'Rose', cost: 1, image: 'https://i.imgur.com/5fX2d8A.png' }, { name: 'Chocolate', cost: 5, image: 'https://i.imgur.com/a7C4d0g.png' }, { name: 'Crown', cost: 10, image: 'https://i.imgur.com/k2gYQ2c.png' }, { name: 'Car', cost: 50, image: 'https://i.imgur.com/eB3R0Gf.png' }];
  
  firebase.initializeApp(firebaseConfig);
  const firestore = firebase.firestore();
  const rdb = firebase.database();
  const liveMediaRef = rdb.ref('/live_media_v2');
  const livePollRef = rdb.ref('/live_poll');
  const gameRef = rdb.ref('/game/tic-tac-toe');

  const getEl = id => document.getElementById(id);
  
  let profile = JSON.parse(localStorage.getItem(PROFILE_KEY) || 'null');
  let isAdmin = profile && profile.uid === ADMIN_UID;
  let userBalance = 0; let balanceListener = null; let selectedImageFile = null; let hls; let typingTimeout;
  let onlineUsers = {}; let currentReplyingTo = null;
  
  let localStream; let peerConnections = {}; let audioContext; let streamAnalyzers = {};
  let isMediaHost = false; let isSeeking = false;
  
  document.addEventListener('DOMContentLoaded', () => {
    initApp();
    initChat();
    initModals();
    initTiBot();
    setupPresence();
    listenForOnlineUsers();
    listenForMediaChanges();
    listenForPollChanges();
    setupVideoEventListeners();
    if (profile) { initVoiceChat(); listenForRtcSignals(); }
  });

  function initApp() {
    if (isAdmin) {
        getEl('adminPanelBtn').style.display = 'flex';
        getEl('adminPanelBtn').onclick = () => getEl('adminModal').style.display = 'flex';
        getEl('createPollBtn').onclick = () => { getEl('pollCreator').style.display = getEl('pollCreator').style.display === 'none' ? 'block' : 'none'; };
        getEl('submitPollBtn').onclick = submitPoll;
        getEl('shareScreenBtn').onclick = shareScreen;
    }
    getEl('backToMenuBtn').onclick = () => setLiveMedia(null);
    getEl('menuContainer').addEventListener('click', (e) => {
        const button = e.target.closest('.menu-btn');
        if (!button || !isAdmin) { if (button && !isAdmin) alert("Only the admin can change the media."); return; }
        const action = button.dataset.action;
        switch(action) {
            case 'playVideo': playVideoFromPrompt(); break;
            case 'playYoutube': setLiveMedia({ type: 'youtube_search' }); break;
            case 'playRadio': getEl('radioModal').style.display = 'flex'; break;
            case 'playGame': setLiveMedia({ type: 'game' }); break;
        }
    });
    getEl('youtubeSearchBtn').onclick = searchYoutube;
    getEl('youtubeQuery').addEventListener('keydown', e => { if (e.key === 'Enter') searchYoutube(); });
  }
  
  function setLiveMedia(state) {
    if (profile && isAdmin) {
      const mediaData = state ? { ...state, initiatedBy: profile.uid, playbackState: { isPlaying: true, currentTime: 0, timestamp: firebase.database.ServerValue.TIMESTAMP } } : null;
      liveMediaRef.set(mediaData);
    } else if (!isAdmin) {
        alert("Only the admin can control the media.");
    } else {
        alert("Please create a profile to control the media.");
    }
  }

  function listenForMediaChanges() { liveMediaRef.on('value', snapshot => { updateMediaDisplay(snapshot.val()); }); }

  function updateMediaDisplay(mediaState) {
    const videoWrapper = getEl('videoWrapper');
    const existingIframe = videoWrapper.querySelector('iframe');
    if (existingIframe) existingIframe.remove();
    if (hls) { hls.destroy(); hls = null; }

    getEl('videoPlayer').src = ''; getEl('videoPlayer').srcObject = null; getEl('audioPlayer').src = '';
    ['videoPlayer', 'audioPlayer'].forEach(id => getEl(id).style.display = 'none');
    ['menuContainer', 'youtubeContainer', 'gameContainer'].forEach(id => getEl(id).classList.remove('active'));
    videoWrapper.classList.remove('menu-active');
    
    if (!mediaState) { 
        videoWrapper.classList.add('menu-active');
        getEl('menuContainer').classList.add('active');
        getEl('backToMenuBtn').style.display = 'none';
        livePollRef.remove(); gameRef.remove();
    } else {
        getEl('backToMenuBtn').style.display = 'flex';
        switch (mediaState.type) {
            case 'youtube_search': getEl('youtubeContainer').classList.add('active'); break;
            case 'youtube': playYoutubeVideo(mediaState.source); break;
            case 'direct': loadSource(mediaState.source, getEl('videoPlayer')); break;
            case 'radio': loadSource(mediaState.source, getEl('audioPlayer')); break;
            case 'game': getEl('gameContainer').classList.add('active'); initGame(); break;
            case 'screenshare': if (mediaState.source !== 'local') { videoWrapper.innerHTML += '<h2 style="color:white;text-align:center;">Admin is sharing their screen.</h2>'; } break;
        }
    }
  }

  function setupVideoEventListeners() { /* No changes from before */ }
  function playVideoFromPrompt() { const url = prompt("Enter video URL (.m3u8, .mp4):"); if (url) setLiveMedia({ type: 'direct', source: url }); }
  async function searchYoutube() { const query = getEl('youtubeQuery').value.trim(); if (!query) return; getEl('youtubeResults').innerHTML = '<div class="video-loader" style="display:block; position:relative; margin:auto;"></div>'; try { const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&key=${YOUTUBE_API_KEY}&type=video&maxResults=20`); const data = await res.json(); if (data.items) { getEl('youtubeResults').innerHTML = data.items.map(item => `<div class="youtube-item" data-video-id="${item.id.videoId}"><img src="${item.snippet.thumbnails.default.url}" alt="${escapeHtml(item.snippet.title)}"><span class="title">${escapeHtml(item.snippet.title)}</span></div>`).join(''); getEl('youtubeResults').querySelectorAll('.youtube-item').forEach(item => { item.onclick = () => setLiveMedia({ type: 'youtube', source: item.dataset.videoId }); }); } } catch (e) { console.error("YT search failed", e); getEl('youtubeResults').innerHTML = '<span>Search failed.</span>'; } }
  function playYoutubeVideo(videoId) { switchToIframe(`https://www.youtube.com/embed/${videoId}?autoplay=1&controls=1`); }
  function loadSource(url, player) { getEl('videoWrapper').classList.add('loading'); player.style.display = 'block'; if (url.includes('.m3u8') && Hls.isSupported() && player.tagName === 'VIDEO') { hls = new Hls(); hls.loadSource(url); hls.attachMedia(player); hls.on(Hls.Events.MANIFEST_PARSED, () => player.play().catch(console.warn)); } else { player.src = url; player.play().catch(console.warn); } ['canplay', 'playing', 'error'].forEach(evt => player.addEventListener(evt, () => getEl('videoWrapper').classList.remove('loading'))); }
  function switchToIframe(url) { const iframe = document.createElement('iframe'); iframe.src = url; iframe.allow = "autoplay; encrypted-media; picture-in-picture"; iframe.allowFullscreen = true; getEl('videoWrapper').appendChild(iframe); getEl('videoWrapper').classList.remove('loading'); }

  function initChat() {
    renderProfileStatus();
    getEl('msgInput').addEventListener('focus', () => { if (!profile) getEl('profileModal').style.display = 'flex'; });
    getEl('msgInput').addEventListener('input', () => { updateSendButtonState(); if (profile) { handleTyping(); handleMention(event); } });
    getEl('sendBtn').onclick = sendMessage;
    getEl('msgInput').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
    getEl('imageUploadBtn').onclick = () => (profile ? getEl('imageInput').click() : getEl('profileModal').style.display = 'flex');
    getEl('imageInput').onchange = e => { selectedImageFile = e.target.files[0]; if (selectedImageFile) { getEl('imagePreviewBox').innerHTML = `<div class="image-preview"><img src="${URL.createObjectURL(selectedImageFile)}"><span class="filename">${escapeHtml(selectedImageFile.name)}</span><button onclick="cancelImageUpload()">&times;</button></div>`; } updateSendButtonState(); };
    getEl('giftBtn').onclick = () => { if (!profile) return getEl('profileModal').style.display = 'flex'; openGiftModal(null); };
    firestore.collection('chats').orderBy('createdAt').limitToLast(100).onSnapshot(handleNewMessages);
    getEl('scrollToBottomBtn').onclick = () => { getEl('messagesBox').scrollTo({ top: getEl('messagesBox').scrollHeight, behavior: 'smooth' }); getEl('scrollToBottomBtn').classList.remove('visible'); };
    getEl('messagesBox').onscroll = () => { if (getEl('messagesBox').scrollHeight - getEl('messagesBox').clientHeight <= getEl('messagesBox').scrollTop + 10) { getEl('scrollToBottomBtn').classList.remove('visible'); } };
  }
  
  window.replyToMessage = (messageId, author, text) => { currentReplyingTo = { messageId, author, text }; getEl('replyPreviewBox').innerHTML = `<div class="reply-preview"><span class="name">Replying to <strong>${escapeHtml(author)}</strong></span><button onclick="cancelReply()">&times;</button></div>`; getEl('msgInput').focus(); }
  window.cancelReply = () => { currentReplyingTo = null; getEl('replyPreviewBox').innerHTML = ''; };
  
  function handleMention(e) { const text = e.target.value; const mentionQuery = text.substring(text.lastIndexOf('@') + 1); const isMentioning = text.lastIndexOf('@') > -1 && text.lastIndexOf(' ') < text.lastIndexOf('@'); if (isMentioning && mentionQuery.length > 0) { const suggestions = Object.values(onlineUsers).filter(u => u.name && u.name.toLowerCase().startsWith(mentionQuery.toLowerCase()) && u.uid !== profile.uid); if (suggestions.length > 0) { getEl('mentionSuggestions').innerHTML = suggestions.map(u => `<div class="mention-item" data-name="${u.name}"><img src="${u.avatar}" alt="${u.name}"><span>${u.name}</span></div>`).join(''); getEl('mentionSuggestions').style.display = 'block'; getEl('mentionSuggestions').querySelectorAll('.mention-item').forEach(item => { item.onclick = () => selectMention(item.dataset.name); }); } else { getEl('mentionSuggestions').style.display = 'none'; } } else { getEl('mentionSuggestions').style.display = 'none'; } }
  function selectMention(name) { const input = getEl('msgInput'); const text = input.value; const lastAt = text.lastIndexOf('@'); input.value = text.substring(0, lastAt) + `@${name} `; input.focus(); getEl('mentionSuggestions').style.display = 'none'; }
  function processMentions(text) { if (!text) return ''; return escapeHtml(text).replace(/@(\w+)/g, (match, name) => { const user = Object.values(onlineUsers).find(u => u.name === name); return user ? `<span class="mention" data-uid="${user.uid}">${match}</span>` : match; }); }
  
  function handleTyping() { clearTimeout(typingTimeout); const typingRef = rdb.ref('/typing/' + profile.uid); if (getEl('msgInput').value.trim()) { typingRef.set(profile.name); typingTimeout = setTimeout(() => typingRef.remove(), 2000); } else { typingRef.remove(); } }
  
  function handleNewMessages(snapshot) { const wasScrolledToBottom = getEl('messagesBox').scrollHeight - getEl('messagesBox').clientHeight <= getEl('messagesBox').scrollTop + 10; snapshot.docChanges().forEach(change => { if (change.type === 'added') { const data = change.doc.data(); const docId = change.doc.id; const time = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ''; let messageHtml = ''; const isAdminMsg = data.uid === ADMIN_UID; const nameClass = isAdminMsg ? 'name admin' : 'name'; switch(data.type || 'message') { case 'gift': messageHtml = `<div class="message gift-message"><div class="content"><div class="text">🎁 <strong>${escapeHtml(data.senderName)}</strong> gifted a ${escapeHtml(data.giftName)} to <strong>${escapeHtml(data.recipientName)}</strong>!</div></div></div>`; break; case 'poll': messageHtml = `<div class="message poll-message" id="poll-${docId}">${renderPoll(docId, data)}</div>`; break; case 'withdrawal_notification': messageHtml = `<div class="message notification-message"><div class="content"><strong>${escapeHtml(data.name)}</strong> submitted a withdrawal request for <strong>${data.amount} BDT</strong>.</div></div>`; break; case 'game': messageHtml = `<div class="message game-message"><div class="content">${escapeHtml(data.text)}</div></div>`; break; default: const replyQuote = data.replyingTo ? `<div class="reply-quote"><div class="author">${escapeHtml(data.replyingTo.author)}</div><div class="text-snippet">${escapeHtml(data.replyingTo.text)}</div></div>` : ''; messageHtml = `<div class="message" data-msg-id="${docId}"><img src="${data.avatar}" alt="avatar" class="avatar" onclick="openUserProfileModal('${data.uid}')"><div class="content">${replyQuote}<div class="metadata"><div class="${nameClass}" onclick="getEl('msgInput').value += '@${data.name} '; getEl('msgInput').focus();">${escapeHtml(data.name)}</div><div class="time">${time}</div><button onclick="replyToMessage('${docId}', '${escapeHtml(data.name)}', '${escapeHtml(data.text || 'Image')}')" style="background:none; border:none; color:var(--text-muted); cursor:pointer; padding: 0 5px;">↰</button></div>${data.imageUrl ? `<img src="${data.imageUrl}" class="chat-image" onclick="openLightbox('${data.imageUrl}')">` : ''}${data.text ? `<div class="text">${processMentions(data.text)}</div>` : ''}</div></div>`; } getEl('messagesBox').insertAdjacentHTML('beforeend', messageHtml); } }); if(wasScrolledToBottom) { requestAnimationFrame(() => { getEl('messagesBox').scrollTop = getEl('messagesBox').scrollHeight; }); } else if (snapshot.docChanges().length > 0) { getEl('scrollToBottomBtn').classList.add('visible'); } }
  
  async function sendMessage() { if (!profile) return; const text = getEl('msgInput').value.trim(); if (!text && !selectedImageFile) return; rdb.ref('/typing/' + profile.uid).remove(); const [tempImage, tempText, tempReply] = [selectedImageFile, text, currentReplyingTo]; getEl('msgInput').value = ''; cancelImageUpload(); cancelReply(); try { let imageUrl = null; if (tempImage) imageUrl = await uploadToImgbb(tempImage); const messageData = { ...profile, type: 'message', createdAt: firebase.firestore.FieldValue.serverTimestamp() }; if (tempText) messageData.text = tempText; if (imageUrl) messageData.imageUrl = imageUrl; if (tempReply) messageData.replyingTo = tempReply; await firestore.collection('chats').add(messageData); updateUserPoints(profile.uid, 5); } catch (e) { console.error("Send failed:", e); } }
  
  const updateSendButtonState = () => { const hasContent = getEl('msgInput').value.trim() || selectedImageFile; getEl('sendBtn').classList.toggle('visible', hasContent); getEl('heartBtn').classList.toggle('hidden', hasContent); };
  
  window.cancelImageUpload = () => { selectedImageFile = null; getEl('imageInput').value = ''; getEl('imagePreviewBox').innerHTML = ''; updateSendButtonState(); };
  
  function setupPresence() { const uid = (profile?.uid) || ('guest_' + Date.now()); const userStatusRef = rdb.ref('/presence/' + uid); rdb.ref('.info/connected').on('value', snap => { if (snap.val()) { userStatusRef.onDisconnect().remove(); const presenceData = { name: profile?.name || 'Guest', uid: profile?.uid, avatar: profile?.avatar }; userStatusRef.set(presenceData); if(profile) { rdb.ref('/typing/' + profile.uid).onDisconnect().remove(); rdb.ref('/webrtc_signals/' + profile.uid).onDisconnect().remove(); } } }); rdb.ref('presence').on('value', snap => { getEl('viewerCount').textContent = `● ${snap.numChildren()} watching`; }); }
  
  function listenForOnlineUsers() { rdb.ref('presence').on('value', snapshot => { onlineUsers = snapshot.val() || {}; getEl('onlineUsersContainer').innerHTML = ''; if (Object.keys(onlineUsers).length === 0) { getEl('onlineUsersContainer').innerHTML = '<span>No one is online.</span>'; return; } Object.values(onlineUsers).forEach(user => { if (user.avatar && user.uid) { const img = document.createElement('img'); img.src = user.avatar; img.title = user.name; img.className = 'online-user-avatar'; img.dataset.uid = user.uid; img.onclick = () => openUserProfileModal(user.uid); getEl('onlineUsersContainer').appendChild(img); } }); if(profile && localStream) manageRtcConnections(Object.values(onlineUsers)); }); }

  async function initVoiceChat() { if (!profile || localStream) return; try { localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false }); audioContext = new (window.AudioContext || window.webkitAudioContext)(); const presenceSnap = await rdb.ref('presence').get(); if (presenceSnap.exists()) { manageRtcConnections(Object.values(presenceSnap.val())); } monitorSpeaking(); } catch (e) { console.error("Mic error:", e); } }
  function manageRtcConnections(onlineUsers) { if (!profile || !localStream) return; const onlineUserUids = onlineUsers.map(u => u.uid).filter(uid => uid && uid !== profile.uid); onlineUserUids.forEach(uid => { if (!peerConnections[uid]) { createPeerConnection(uid, true); } }); Object.keys(peerConnections).forEach(uid => { if (!onlineUserUids.includes(uid)) { peerConnections[uid].close(); delete peerConnections[uid]; const audioEl = getEl('audio_' + uid); if (audioEl) audioEl.remove(); if(streamAnalyzers[uid]) delete streamAnalyzers[uid]; } }); }
  async function createPeerConnection(remoteUid, isInitiator) { if (peerConnections[remoteUid]) return; const pc = new RTCPeerConnection(RTC_CONFIGURATION); peerConnections[remoteUid] = pc; localStream.getTracks().forEach(track => pc.addTrack(track, localStream)); pc.onicecandidate = e => { if (e.candidate) { rdb.ref(`/webrtc_signals/${remoteUid}/${profile.uid}`).push({ ice: e.candidate }); }}; pc.ontrack = e => { let audioEl = getEl('audio_' + remoteUid); if (!audioEl) { audioEl = document.createElement('audio'); audioEl.id = 'audio_' + remoteUid; audioEl.autoplay = true; audioEl.playsInline = true; getEl('audioStreamsContainer').appendChild(audioEl); } if (audioEl.srcObject !== e.streams[0]) { audioEl.srcObject = e.streams[0]; } if (audioContext) { try { const source = audioContext.createMediaStreamSource(e.streams[0]); const analyzer = audioContext.createAnalyser(); analyzer.fftSize = 256; source.connect(analyzer); streamAnalyzers[remoteUid] = { analyzer, dataArray: new Uint8Array(analyzer.frequencyBinCount) }; } catch (err) { console.error("Analyzer error:", err); } } }; if (isInitiator) { try { const offer = await pc.createOffer(); await pc.setLocalDescription(offer); rdb.ref(`/webrtc_signals/${remoteUid}/${profile.uid}`).push({ sdp: pc.localDescription }); } catch (e) { console.error("Offer error:", e); } } }
  function listenForRtcSignals() { if (!profile) return; const signalsRef = rdb.ref(`/webrtc_signals/${profile.uid}`); signalsRef.on('child_added', snapshot => { const senderUid = snapshot.key; if (senderUid === profile.uid) return; snapshot.ref.on('child_added', msgSnap => { handleSignalMessage(senderUid, msgSnap.val()); msgSnap.ref.remove(); }); }); }
  async function handleSignalMessage(senderUid, message) { let pc = peerConnections[senderUid]; if (!pc) { createPeerConnection(senderUid, false); pc = peerConnections[senderUid]; } try { if (message.sdp) { await pc.setRemoteDescription(new RTCSessionDescription(message.sdp)); if (message.sdp.type === 'offer') { const answer = await pc.createAnswer(); await pc.setLocalDescription(answer); rdb.ref(`/webrtc_signals/${senderUid}/${profile.uid}`).push({ sdp: pc.localDescription }); } } else if (message.ice) { await pc.addIceCandidate(new RTCIceCandidate(message.ice)); } } catch (e) { console.error("Signal handle error:", e); } }
  function monitorSpeaking() { const speakingThreshold = 135; function checkLevels() { Object.keys(streamAnalyzers).forEach(uid => { const { analyzer, dataArray } = streamAnalyzers[uid]; analyzer.getByteFrequencyData(dataArray); let sum = dataArray.reduce((a, b) => a + b, 0); const average = sum / dataArray.length; const avatar = document.querySelector(`.online-user-avatar[data-uid="${uid}"]`); if (avatar) { avatar.classList.toggle('speaking', average > speakingThreshold); } }); requestAnimationFrame(checkLevels); } checkLevels(); }
  
  function initModals() {
    ['profileModal', 'withdrawModal', 'radioModal', 'giftModal', 'userProfileModal', 'adminModal', 'lightbox'].forEach(id => {
        const modal = getEl(id);
        if (modal) modal.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };
    });
    getEl('avatarFile').onchange = () => { const file = getEl('avatarFile').files[0]; if (file) { const reader = new FileReader(); reader.onload = e => { getEl('avatarPreview').src = e.target.result; getEl('avatarPreview').style.display = 'block'; }; reader.readAsDataURL(file); } };
    getEl('submitWithdrawBtn').onclick = submitWithdrawal;
    const radioContainer = getEl('radioStationsContainer'); radioContainer.innerHTML += RADIO_STATIONS.map(s => `<div class="radio-station" data-url="${s.url}"><img src="${s.logo}" alt="${s.name}"><div class="name">${s.name}</div></div>`).join('');
    radioContainer.addEventListener('click', e => { const station = e.target.closest('.radio-station'); if (station && isAdmin) { setLiveMedia({ type: 'radio', source: station.dataset.url }); getEl('radioModal').style.display = 'none'; } else if (station && !isAdmin) alert('Only admin can change radio.'); });
    getEl('giftOptionsContainer').addEventListener('click', e => { const giftItem = e.target.closest('.gift-item'); if(giftItem) sendGift(giftItem.dataset.name, parseInt(giftItem.dataset.cost)); });
  }

  async function openUserProfileModal(uid) {
    const user = onlineUsers[uid];
    if (!user) return;
    const modal = getEl('userProfileModal');
    getEl('profileModalAvatar').src = user.avatar;
    getEl('profileModalName').textContent = user.name;
    getEl('profileModalUid').textContent = user.uid;
    modal.style.display = 'flex';
    const userData = (await rdb.ref('users/' + uid).get()).val() || { balance: 0, points: 0 };
    getEl('profileModalBalance').textContent = `৳ ${userData.balance.toFixed(2)}`;
    getEl('profileModalPoints').textContent = userData.points;
    getEl('sendGiftBtn').onclick = () => { modal.style.display = 'none'; openGiftModal(user); };
  }
  
  function openGiftModal(recipient) {
    const modal = getEl('giftModal');
    modal.style.display = 'flex';
    const recipientNameEl = getEl('giftRecipientName');
    recipient = recipient || { name: 'everyone', uid: 'all' };
    recipientNameEl.textContent = recipient.name;
    modal.dataset.recipientUid = recipient.uid;
    modal.dataset.recipientName = recipient.name;
    getEl('giftOptionsContainer').innerHTML = `<h2>Send a Gift</h2><p>Select a gift to send to <strong>${recipient.name}</strong>.</p>` + VIRTUAL_GIFTS.map(g => `<div class="gift-item" data-name="${g.name}" data-cost="${g.cost}"><img src="${g.image}" alt="${g.name}"><div class="cost">৳ ${g.cost}</div></div>`).join('');
  }
  
  async function sendGift(giftName, cost) {
    if (userBalance < cost) return alert("Insufficient balance to send this gift.");
    const recipientUid = getEl('giftModal').dataset.recipientUid;
    const recipientName = getEl('giftModal').dataset.recipientName;
    try {
        await rdb.ref('users/' + profile.uid + '/balance').set(firebase.database.ServerValue.increment(-cost));
        const message = { type: 'gift', senderName: profile.name, recipientName: recipientName, giftName: giftName, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
        if (recipientUid !== 'all') {
            await rdb.ref('users/' + recipientUid + '/balance').set(firebase.database.ServerValue.increment(cost * 0.8)); // Recipient gets 80%
        }
        await firestore.collection('chats').add(message);
        getEl('giftModal').style.display = 'none';
    } catch(e) { console.error("Gift failed:", e); alert("Failed to send gift."); }
  }

  window.openLightbox = (url) => { getEl('lightboxImage').src = url; getEl('lightbox').style.display = 'flex'; };
  function renderProfileStatus() { if (profile && profile.uid) { getEl('profileStatusBox').innerHTML = `<div class="profile-status"><img src="${profile.avatar}"><span class="name">As <strong>${escapeHtml(profile.name)}</strong></span><div class="wallet-info"><span class="balance" id="userBalanceDisplay">৳ 0.00</span><button class="withdraw-btn locked" id="withdrawBtn" title="Withdraw (Min ${MIN_WITHDRAW_AMOUNT} BDT)"><svg viewBox="0 0 24 24"><path d="M18,8H17V6A5,5 0 0,0 12,1A5,5 0 0,0 7,6V8H6A2,2 0 0,0 4,10V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V10A2,2 0 0,0 18,8M12,17A2,2 0 0,1 10,15A2,2 0 0,1 12,13A2,2 0 0,1 14,15A2,2 0 0,1 12,17M15.1,8H8.9V6A3.1,3.1 0 0,1 12,2.9A3.1,3.1 0 0,1 15.1,6V8Z"/></svg>Withdraw</button></div><button class="signout-btn" onclick="signOut()" title="Sign Out">&times;</button></div>`; getEl('withdrawBtn').onclick = openWithdrawModal; listenForBalanceChanges(profile.uid); } else { getEl('profileStatusBox').innerHTML = ''; if (balanceListener) { balanceListener.off(); balanceListener = null; } } }
  window.signOut = () => { if (confirm('Are you sure you want to sign out?')) { if(profile?.uid) { rdb.ref('/presence/' + profile.uid).remove(); } if(balanceListener) balanceListener.off(); localStream?.getTracks().forEach(track => track.stop()); Object.values(peerConnections).forEach(pc => pc.close()); profile = null; localStorage.removeItem(PROFILE_KEY); window.location.reload(); } };
  getEl('createProfileBtn').onclick = async () => { const name = getEl('nameInput').value.trim(); const file = getEl('avatarFile').files[0]; if (!name || !file) return alert('Please provide name and photo.'); getEl('createProfileBtn').disabled = true; getEl('uploading').style.display = 'block'; try { const avatarUrl = await uploadToImgbb(file); const uid = 'u_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9); profile = { uid, name, avatar: avatarUrl }; localStorage.setItem(PROFILE_KEY, JSON.stringify(profile)); await rdb.ref('users/' + uid).set({ balance: 5, points: 0, name: name }); getEl('profileModal').style.display = 'none'; window.location.reload(); } catch (e) { alert("Profile creation failed."); console.error(e); } finally { getEl('createProfileBtn').disabled = false; getEl('uploading').style.display = 'none'; } };
  function listenForTyping() { rdb.ref('/typing').on('value', snap => { const typers = snap.val() || {}; const activeTypers = Object.keys(typers).filter(uid => uid !== profile?.uid).map(uid => escapeHtml(typers[uid])); if(activeTypers.length > 0) { let text = activeTypers.slice(0, 2).join(', ') + (activeTypers.length > 2 ? ' and others' : ''); text += (activeTypers.length > 1 ? ' are' : ' is') + ' typing...'; getEl('typingIndicator').textContent = text; getEl('typingIndicator').classList.add('visible'); } else { getEl('typingIndicator').classList.remove('visible'); } }); }
  function listenForBalanceChanges(uid) { if (balanceListener) balanceListener.off(); const userBalanceRef = rdb.ref('users/' + uid + '/balance'); balanceListener = userBalanceRef.on('value', snapshot => { userBalance = snapshot.val() || 0; const balanceDisplay = getEl('userBalanceDisplay'); const withdrawBtn = getEl('withdrawBtn'); if (balanceDisplay) balanceDisplay.textContent = `৳ ${userBalance.toFixed(2)}`; if (withdrawBtn) { const isLocked = userBalance < MIN_WITHDRAW_AMOUNT; withdrawBtn.classList.toggle('locked', isLocked); withdrawBtn.disabled = isLocked; withdrawBtn.querySelector('svg path').setAttribute('d', isLocked ? 'M18,8H17V6A5,5 0 0,0 12,1A5,5 0 0,0 7,6V8H6A2,2 0 0,0 4,10V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V10A2,2 0 0,0 18,8M12,17A2,2 0 0,1 10,15A2,2 0 0,1 12,13A2,2 0 0,1 14,15A2,2 0 0,1 12,17M15.1,8H8.9V6A3.1,3.1 0 0,1 12,2.9A3.1,3.1 0 0,1 15.1,6V8Z' : 'M18,8H17V6A5,5 0 0,0 12,1A5,5 0 0,0 7,6H8.9V8H15.1V6A3.1,3.1 0 0,0 12,2.9A3.1,3.1 0 0,0 8.9,6H7V8H6A2,2 0 0,0 4,10V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V10A2,2 0 0,0 18,8M12,17A2,2 0 0,1 10,15A2,2 0 0,1 12,13A2,2 0 0,1 14,15A2,2 0 0,1 12,17Z'); } }); }
  function openWithdrawModal() { if(userBalance < MIN_WITHDRAW_AMOUNT) { alert(`You need at least ${MIN_WITHDRAW_AMOUNT} BDT to withdraw.`); return; } getEl('withdrawModal').style.display = 'flex'; }
  async function submitWithdrawal() { const number = getEl('withdrawNumberInput').value.trim(); const gpRegex = /^(017|013)\d{8}$/; if (!gpRegex.test(number)) { alert('Please enter a valid Grameenphone number (e.g., 017... or 013...).'); return; } this.disabled = true; try { await rdb.ref('users/' + profile.uid + '/balance').set(firebase.database.ServerValue.increment(-MIN_WITHDRAW_AMOUNT)); await rdb.ref('withdrawal_requests').push({ uid: profile.uid, name: profile.name, number: number, amount: MIN_WITHDRAW_AMOUNT, status: 'pending', timestamp: firebase.database.ServerValue.TIMESTAMP }); await firestore.collection('chats').add({ type: 'withdrawal_notification', name: profile.name, amount: MIN_WITHDRAW_AMOUNT, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); alert('Withdrawal request submitted!'); getEl('withdrawModal').style.display = 'none'; getEl('withdrawNumberInput').value = ''; } catch (error) { alert('An error occurred.'); console.error('Withdrawal Error:', error); } finally { this.disabled = false; } }
  async function updateUserPoints(uid, pointsToAdd) { if (!uid) return; try { await rdb.ref('users/' + uid + '/points').set(firebase.database.ServerValue.increment(pointsToAdd)); } catch(e) { console.error('Failed to update points', e); } }
  function initTiBot() { setInterval(async () => { try { const onlineUIDs = Object.keys(onlineUsers).filter(uid => uid.startsWith('u_')); if (onlineUIDs.length < 2) return; const highestUser = { uid: null, points: -1, name: '' }; for (const uid of onlineUIDs) { const userSnap = await rdb.ref(`users/${uid}/points`).get(); const points = userSnap.val() || 0; if (points > highestUser.points) { highestUser.uid = uid; highestUser.points = points; highestUser.name = onlineUsers[uid]?.name || 'A User'; } } if (highestUser.uid && highestUser.points > 10) { const giftAmount = 1; await rdb.ref('users/' + highestUser.uid).update({ balance: firebase.database.ServerValue.increment(giftAmount), points: 0 }); await firestore.collection('chats').add({ type: 'gift', senderName: 'Ti Bot', recipientName: highestUser.name, giftName: `🎁 ${giftAmount} BDT Bonus`, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); } } catch (error) { console.error("Ti Bot Error:", error); } }, 120000); }
  async function uploadToImgbb(file) { const formData = new FormData(); formData.append('image', file); const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData }); const data = await res.json(); if (!data.success) throw new Error(data.error.message); return data.data.url; }
  const escapeHtml = str => str?.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]) || '';
  
  function submitPoll() { const q = getEl('pollQuestion').value.trim(); const opts = getEl('pollOptions').value.trim(); if (!q || !opts) return; const options = opts.split('\n').map(o => o.trim()).filter(Boolean); if (options.length < 2) return alert('At least two options required.'); const pollData = { question: q, options: options.map(o => ({ text: o, votes: 0 })), voters: {} }; firestore.collection('chats').add({ type: 'poll', ...pollData, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); getEl('adminModal').style.display = 'none'; getEl('pollCreator').style.display = 'none'; getEl('pollQuestion').value = ''; getEl('pollOptions').value = ''; }
  function renderPoll(id, data) { const totalVotes = data.options.reduce((sum, opt) => sum + opt.votes, 0); const hasVoted = profile && data.voters && data.voters[profile.uid]; return `<div class="content"><div class="poll-question">${escapeHtml(data.question)}</div>` + data.options.map((opt, index) => { const percentage = totalVotes > 0 ? ((opt.votes / totalVotes) * 100).toFixed(0) : 0; const isMyVote = hasVoted === index; return `<div class="poll-option ${isMyVote ? 'voted-by-me' : ''}" onclick="voteOnPoll('${id}', ${index})"><div class="progress" style="width: ${percentage}%;"></div><div class="text-content"><span>${escapeHtml(opt.text)}</span><span class="percentage">${hasVoted ? `${percentage}%` : ''}</span></div></div>`; }).join('') + `</div>`; }
  async function voteOnPoll(id, index) { if (!profile) return alert('Please create a profile to vote.'); const pollRef = firestore.collection('chats').doc(id); const doc = await pollRef.get(); if (!doc.exists) return; const data = doc.data(); if (data.voters && data.voters[profile.uid] !== undefined) return alert('You have already voted.'); const newOptions = [...data.options]; newOptions[index].votes += 1; const newVoters = { ...data.voters, [profile.uid]: index }; pollRef.update({ options: newOptions, voters: newVoters }); }
  function listenForPollChanges() { firestore.collection('chats').where('type', '==', 'poll').onSnapshot(snapshot => { snapshot.docChanges().forEach(change => { if (change.type === 'modified') { const id = change.doc.id; const data = change.doc.data(); const pollEl = getEl(`poll-${id}`); if (pollEl) pollEl.innerHTML = renderPoll(id, data); } }); }); }
  async function shareScreen() { try { const stream = await navigator.mediaDevices.getDisplayMedia({ video: true }); getEl('videoPlayer').srcObject = stream; getEl('videoPlayer').style.display = 'block'; getEl('videoPlayer').muted = true; getEl('videoPlayer').play(); setLiveMedia({ type: 'screenshare', source: 'local' }); getEl('adminModal').style.display = 'none'; } catch (err) { console.error("Screen share error:", err); } }
  
  function initGame() { listenForGameState(); const board = getEl('ticTacToeBoard'); board.innerHTML = ''; for (let i = 0; i < 9; i++) { const cell = document.createElement('div'); cell.className = 'ttt-cell'; cell.dataset.index = i; cell.onclick = () => makeMove(i); board.appendChild(cell); } getEl('resetGameBtn').onclick = resetGame; }
  function resetGame() { if (!isAdmin) return; gameRef.set({ board: Array(9).fill(null), turn: 'X', winner: null, players: {}, isDraw: false }); firestore.collection('chats').add({ type: 'game', text: 'Admin reset the game.', createdAt: firebase.firestore.FieldValue.serverTimestamp() }); }
  async function makeMove(index) { const snapshot = await gameRef.once('value'); const gameState = snapshot.val(); if (!gameState || gameState.winner || gameState.isDraw || gameState.board[index] !== null || !profile) return; let playerSymbol; const existingPlayerSymbol = Object.keys(gameState.players || {}).find(key => gameState.players[key] === profile.uid); if (existingPlayerSymbol) { playerSymbol = existingPlayerSymbol; } else if (!gameState.players?.X) { playerSymbol = 'X'; gameRef.child('players/X').set(profile.uid); } else if (!gameState.players?.O) { playerSymbol = 'O'; gameRef.child('players/O').set(profile.uid); } else { alert("Game is full."); return; } if (gameState.turn === playerSymbol) { const newBoard = [...gameState.board]; newBoard[index] = gameState.turn; const winner = calculateWinner(newBoard); const isDraw = !winner && newBoard.every(cell => cell !== null); gameRef.update({ board: newBoard, turn: gameState.turn === 'X' ? 'O' : 'X', winner: winner, isDraw: isDraw }); if (winner) firestore.collection('chats').add({ type: 'game', text: `Player ${winner} wins! 🎉`, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); else if (isDraw) firestore.collection('chats').add({ type: 'game', text: `The game is a draw! 🤝`, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); } }
  function listenForGameState() { gameRef.on('value', snapshot => { const gameState = snapshot.val(); if (!gameState || !getEl('gameContainer').classList.contains('active')) return; getEl('ticTacToeBoard').querySelectorAll('.ttt-cell').forEach((cell, index) => { cell.textContent = gameState.board[index]; }); const statusEl = getEl('gameStatus'); if (gameState.winner) { statusEl.textContent = `Winner: ${gameState.winner}`; } else if (gameState.isDraw) { statusEl.textContent = "It's a Draw!"; } else { statusEl.textContent = `Turn: ${gameState.turn}`; } if (isAdmin) getEl('resetGameBtn').style.display = 'block'; }); }
  function calculateWinner(squares) { const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]]; for (let i = 0; i < lines.length; i++) { const [a,b,c] = lines[i]; if (squares[a] && squares[a] === squares[b] && squares[a] === squares[c]) return squares[a]; } return null; }
</script>
</body>
</html>
